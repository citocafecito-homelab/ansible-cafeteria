- name: Ensure dependencies are present
  become: true
  ansible.builtin.package:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
      - python3-pip

- name: Instal Packages for {{ ansible_os_family }}
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/tasks/packages/{{ ansible_os_family | lower }}.yml"

- name: Install Kubernetes core packages
  become: true
  ansible.builtin.package:
    name:
      - kubeadm
      - kubelet
      - containerd
      - kubectl
    state: present

- name: Hold Kubernetes packages at current version
  become: true
  vars:
    package_hold_command:
      Debian: "apt-mark hold"
      RedHat: "yum versionlock"
      Suse: "zypper addlock"
      Archlinux: "pacman -S --sync"
  ansible.builtin.command:
    cmd: "{{ package_hold_command[ansible_os_family] }} kubeadm kubelet containerd"
  changed_when: false

- name: Download and unarchive CNI plugins
  become: true
  ansible.builtin.unarchive:
    src: "{{ 'https://github.com/containernetworking/plugins/releases/download/' ~
      k8s_cni_plugin_version ~
      '/cni-plugins-linux-amd64-' ~
      k8s_cni_plugin_version ~
      '.tgz' }}"
    dest: /opt/cni/bin
    remote_src: true
    owner: root
    group: root
    extra_opts: [--overwrite]
    creates: /opt/cni/bin/bridge

- name: Install Kubernetes Python client
  become: true
  ansible.builtin.pip:
    name: kubernetes
    state: present
    break_system_packages: true
    executable: pip3
