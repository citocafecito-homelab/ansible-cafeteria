- name: Enable IP forwarding
  become: true
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: true

- name: Configure crictl to use containerd
  become: true
  ansible.builtin.copy:
    dest: /etc/crictl.yaml
    mode: '0644'
    content: |
      runtime-endpoint: unix:///run/containerd/containerd.sock
      image-endpoint: unix:///run/containerd/containerd.sock
      timeout: 10
      debug: false

- name: Enable and start required services
  become: true
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - containerd
    - kubelet

- name: Render kubeadm init config
  become: true
  ansible.builtin.template:
    src: kubeadm-init.yaml.j2
    dest: /etc/kubernetes/kubeadm-init.yaml
    owner: root
    group: root
    mode: '0644'

- name: Init kubeadm with system:masters group
  become: true
  ansible.builtin.command: kubeadm init --config=/etc/kubernetes/kubeadm-init.yaml
  args:
    creates: /etc/kubernetes/admin.conf
