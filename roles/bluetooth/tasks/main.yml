- name: Install bluez on Debian/Ubuntu
  ansible.builtin.package:
    name: [bluez, bluez-tools]
    state: present
  when: ansible_os_family == "Debian"

- name: Install bluez on Fedora/RHEL (Traditional)
  ansible.builtin.dnf:
    name: [bluez, bluez-tools]
    state: present
    use_backend: dnf5
  when: 
    - ansible_os_family == "RedHat"
    - ansible_distribution_os_variant not in ['coreos', 'silverblue', 'kinoite']

- name: Install bluez on OSTree variants (CoreOS/Silverblue)
  community.general.rpm_ostree_pkg:
    name: [bluez, bluez-tools]
    state: present
  when: 
    - ansible_os_family == "RedHat"
    - ansible_distribution_os_variant in ['coreos', 'silverblue', 'kinoite']

- name: Ensure /etc/bluetooth directory exists with correct permissions
  become: true
  ansible.builtin.file:
    path: /etc/bluetooth
    state: directory
    mode: '0555'

- name: Ensure Bluetooth service is running and enabled
  become: true
  ansible.builtin.systemd:
    name: bluetooth
    state: started
    enabled: true