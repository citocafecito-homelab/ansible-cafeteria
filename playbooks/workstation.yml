# ------------------------------------------------------------------------------
# Workstation Setup
#
# This play configures a developer workstation using optional, flag-based roles.
#
# ðŸ§ª Local testing
# To run this playbook safely on localhost for testing purposes:
#
#   1. Use the test inventory:
#        ansible-playbook playbooks/main.yml -i inventory.test.ini
#
#   2. Enable/disable roles explicitly in:
#        host_vars/localhost.yml
#
# Only roles with `<role>_enabled: true` will be executed.
# This prevents destructive or unwanted changes during local testing.
# ------------------------------------------------------------------------------
- name: Workstation Setup
  hosts: workstation
  gather_facts: true
  pre_tasks:
    - name: Install App
      become: true
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - gnupg
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

  tasks:
    - name: Install dependencies conditionally
      become: true
      ansible.builtin.package:
        name: "{{ item.pkg }}"
        state: present
      loop:
        - { pkg: kubectl, enabled: "{{ k8s_enabled | default(false) }}" }
        - { pkg: curl, enabled: true }
        - { pkg: git, enabled: true }
      when: item.enabled
      loop_control:
        label: "{{ item.pkg }}"

  roles:
    # System
    - { role: bluetooth, when: bluetooth_enabled | default(false) | bool }
    - { role: nfs, when: nfs_enabled | default(false) | bool }

    # Secret manager
    - { role: vault, when: vault_enabled | default(false) | bool }

    # Development Tools
    - { role: dev_tools }
